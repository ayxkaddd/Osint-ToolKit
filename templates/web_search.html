{% extends "base.html" %}

{% block title %}Web Search - Auto dorking{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Search - Auto dorking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-black text-white font-mono min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Hero Search Section -->
        <div class="flex flex-col items-center justify-center min-h-[30vh]">
            <h1 class="text-4xl font-bold mb-4">Web Search</h1>
            <p class="text-gray-400 text-lg mb-8">Search digital footprint using auto-generated dorks</p>

            <div class="w-full max-w-2xl space-y-4">
                <!-- Value Input -->
                <input type="text" id="searchInput" placeholder="Enter value to search..."
                    class="w-full bg-gray-900 border border-gray-700 rounded-lg py-3 px-4 text-white placeholder-gray-500 focus:outline-none focus:border-gray-500 transition-colors">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Input Type Dropdown -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Input Type</label>
                        <select id="inputType"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg py-3 px-4 text-white focus:outline-none focus:border-gray-500 transition-colors appearance-none cursor-pointer">
                            <option value="username">Username</option>
                            <option value="full_name">Full Name</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone</option>
                        </select>
                    </div>

                    <!-- Engine Checkboxes -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Search Engines</label>
                        <div class="flex gap-4">
                            <label
                                class="flex items-center gap-2 p-3 bg-gray-800/50 rounded-lg hover:bg-gray-800 transition-colors cursor-pointer flex-1 border border-gray-700/50">
                                <input type="checkbox" class="engine-checkbox rounded bg-gray-700 border-gray-600"
                                    value="google" checked>
                                <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                                <span class="text-sm">Google</span>
                            </label>
                            <label
                                class="flex items-center gap-2 p-3 bg-gray-800/50 rounded-lg hover:bg-gray-800 transition-colors cursor-pointer flex-1 border border-gray-700/50">
                                <input type="checkbox" class="engine-checkbox rounded bg-gray-700 border-gray-600"
                                    value="yandex">
                                <i data-lucide="globe" class="w-4 h-4 text-gray-400"></i>
                                <span class="text-sm">Yandex</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Preview Button -->
                <button id="previewButton"
                    class="w-full bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg px-6 py-3 transition-colors flex items-center justify-center gap-2 opacity-50 cursor-not-allowed"
                    disabled>
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Preview Dorks
                </button>
            </div>
        </div>

        <!-- Error Toast -->
        <div id="errorToast" class="hidden fixed top-6 right-6 z-50 max-w-md">
            <div class="bg-red-950 border border-red-800 rounded-lg p-4 flex items-start gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-400 shrink-0 mt-0.5"></i>
                <div>
                    <p class="text-sm font-bold text-red-300">Error</p>
                    <p id="errorMessage" class="text-sm text-red-400 mt-1"></p>
                </div>
                <button id="errorClose" class="text-red-400 hover:text-red-300 ml-auto shrink-0">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center my-8 gap-3">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-white"></div>
            <p id="loadingText" class="text-sm text-gray-400">Loading...</p>
        </div>

        <!-- Preview Panel -->
        <div id="previewPanel" class="hidden mt-8">
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="code-2" class="w-5 h-5 text-gray-400"></i>
                        <h3 class="text-lg font-bold">Generated Dorks</h3>
                    </div>
                    <div class="text-sm text-gray-400">
                        Querying: <span id="previewValue" class="text-white font-bold"></span>
                    </div>
                </div>

                <!-- Dorks by Engine -->
                <div id="dorksContainer" class="space-y-6">
                    <!-- Dynamically populated -->
                </div>

                <!-- Preview Controls -->
                <div class="mt-6 flex gap-3">
                    <button id="runSearchButton"
                        class="flex-1 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg px-6 py-3 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="play" class="w-4 h-4"></i>
                        Run Search
                    </button>
                    <button id="editCustomButton"
                        class="flex-1 bg-gray-800/50 hover:bg-gray-800 border border-gray-700/50 rounded-lg px-6 py-3 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                        Edit & Run Custom
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Dorks Editor -->
        <div id="customEditorPanel" class="hidden mt-4">
            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="terminal" class="w-5 h-5 text-gray-400"></i>
                    <h3 class="text-lg font-bold">Custom Dork Editor</h3>
                </div>
                <p class="text-sm text-gray-400 mb-4">Edit dork queries below (one per line). These will be sent to
                    all selected engines.</p>
                <textarea id="customDorksTextarea"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg py-3 px-4 text-white text-sm font-mono placeholder-gray-500 focus:outline-none focus:border-gray-500 transition-colors resize-y min-h-[160px]"
                    placeholder="Enter custom dork queries, one per line..."></textarea>
                <div class="mt-4 flex gap-3">
                    <button id="runCustomSearchButton"
                        class="flex-1 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg px-6 py-3 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="play" class="w-4 h-4"></i>
                        Run Custom Search
                    </button>
                    <button id="cancelCustomButton"
                        class="bg-gray-800/50 hover:bg-gray-800 border border-gray-700/50 rounded-lg px-6 py-3 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="statsContainer" class="hidden mt-8 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center">
                    <p class="text-gray-400 text-sm mb-1">Total Results</p>
                    <p id="statTotalResults" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center">
                    <p class="text-gray-400 text-sm mb-1">Engines Used</p>
                    <p id="statEnginesUsed" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-center">
                    <p class="text-gray-400 text-sm mb-1">Dorks Executed</p>
                    <p id="statDorksExecuted" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="space-y-4">
            <!-- Results will be dynamically inserted here -->
        </div>
    </div>

    {% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Element References ---
            const searchInput = document.getElementById('searchInput');
            const inputType = document.getElementById('inputType');
            const previewButton = document.getElementById('previewButton');
            const previewPanel = document.getElementById('previewPanel');
            const dorksContainer = document.getElementById('dorksContainer');
            const previewValue = document.getElementById('previewValue');
            const runSearchButton = document.getElementById('runSearchButton');
            const editCustomButton = document.getElementById('editCustomButton');
            const customEditorPanel = document.getElementById('customEditorPanel');
            const customDorksTextarea = document.getElementById('customDorksTextarea');
            const runCustomSearchButton = document.getElementById('runCustomSearchButton');
            const cancelCustomButton = document.getElementById('cancelCustomButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingText = document.getElementById('loadingText');
            const statsContainer = document.getElementById('statsContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const errorToast = document.getElementById('errorToast');
            const errorMessage = document.getElementById('errorMessage');
            const errorClose = document.getElementById('errorClose');
            const healthDot = document.getElementById('healthDot');
            const healthText = document.getElementById('healthText');

            let currentPreviewData = null;

            // --- Initialize Lucide Icons ---
            lucide.createIcons();

            // --- Input Validation ---
            function updatePreviewButton() {
                const hasValue = searchInput.value.trim().length > 0;
                const hasEngine = document.querySelectorAll('.engine-checkbox:checked').length > 0;
                const enabled = hasValue && hasEngine;
                previewButton.disabled = !enabled;
                previewButton.classList.toggle('opacity-50', !enabled);
                previewButton.classList.toggle('cursor-not-allowed', !enabled);
            }
            searchInput.addEventListener('input', updatePreviewButton);
            document.querySelectorAll('.engine-checkbox').forEach(cb => {
                cb.addEventListener('change', updatePreviewButton);
            });

            // --- Error Handling ---
            function showError(msg) {
                errorMessage.textContent = msg;
                errorToast.classList.remove('hidden');
                setTimeout(() => { errorToast.classList.add('hidden'); }, 6000);
            }
            errorClose.addEventListener('click', () => { errorToast.classList.add('hidden'); });

            // --- Loading ---
            function showLoading(text) {
                loadingText.textContent = text || 'Loading...';
                loadingIndicator.classList.remove('hidden');
            }
            function hideLoading() {
                loadingIndicator.classList.add('hidden');
            }

            // --- Get Selected Engines ---
            function getSelectedEngines() {
                return Array.from(document.querySelectorAll('.engine-checkbox:checked')).map(cb => cb.value);
            }

            // --- Preview Flow ---
            previewButton.addEventListener('click', async function () {
                const value = searchInput.value.trim();
                const engines = getSelectedEngines();
                if (!value || engines.length === 0) return;

                previewPanel.classList.add('hidden');
                customEditorPanel.classList.add('hidden');
                statsContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';
                showLoading('Generating dork queries...');

                try {
                    const res = await fetch('/web/dorks/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            value: value,
                            input_type: inputType.value,
                            engines: engines
                        })
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail || 'Preview request failed');
                    }

                    const data = await res.json();
                    currentPreviewData = data;
                    renderPreview(data);
                } catch (e) {
                    showError(e.message || 'Failed to generate dork preview');
                } finally {
                    hideLoading();
                }
            });

            // --- Render Preview ---
            function renderPreview(data) {
                previewValue.textContent = data.value;
                dorksContainer.innerHTML = '';

                const dorksByEngine = data.dorks_by_engine || {};
                for (const [engine, dorks] of Object.entries(dorksByEngine)) {
                    const engineBlock = document.createElement('div');
                    engineBlock.className = 'space-y-2';
                    engineBlock.innerHTML = `
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="${engine === 'google' ? 'search' : 'globe'}" class="w-4 h-4 text-gray-400"></i>
                            <h4 class="text-sm font-bold uppercase tracking-wider text-gray-300">${engine}</h4>
                            <span class="text-xs text-gray-500">${dorks.length} dorks</span>
                        </div>
                    `;

                    dorks.forEach((dork, idx) => {
                        const dorkRow = document.createElement('div');
                        dorkRow.className = 'flex items-center gap-2 group';
                        dorkRow.innerHTML = `
                            <div class="flex-1 bg-gray-800 border border-gray-700/50 rounded-lg px-4 py-2.5 text-sm text-gray-300 overflow-x-auto whitespace-nowrap">
                                <code>${escapeHtml(dork)}</code>
                            </div>
                            <button class="copy-dork-btn shrink-0 p-2 rounded-lg bg-gray-800/50 border border-gray-700/50 hover:bg-gray-800 transition-colors opacity-0 group-hover:opacity-100" data-dork="${escapeAttr(dork)}" title="Copy dork">
                                <i data-lucide="copy" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        `;
                        engineBlock.appendChild(dorkRow);
                    });

                    dorksContainer.appendChild(engineBlock);
                }

                previewPanel.classList.remove('hidden');
                lucide.createIcons();
                bindCopyButtons();
            }

            // --- Copy Buttons ---
            function bindCopyButtons() {
                document.querySelectorAll('.copy-dork-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const dork = this.getAttribute('data-dork');
                        navigator.clipboard.writeText(dork).then(() => {
                            const icon = this.querySelector('i');
                            icon.setAttribute('data-lucide', 'check');
                            lucide.createIcons();
                            setTimeout(() => {
                                icon.setAttribute('data-lucide', 'copy');
                                lucide.createIcons();
                            }, 1500);
                        });
                    });
                });
            }

            // --- Run Search ---
            runSearchButton.addEventListener('click', async function () {
                const value = searchInput.value.trim();
                const engines = getSelectedEngines();
                if (!value || engines.length === 0) return;

                previewPanel.classList.add('hidden');
                customEditorPanel.classList.add('hidden');
                statsContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';
                showLoading('Executing search across engines...');

                try {
                    const res = await fetch('/web/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            value: value,
                            input_type: inputType.value,
                            engines: engines,
                            max_results_per_dork: 10,
                            rate_limit_delay: 1.0
                        })
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail || 'Search request failed');
                    }

                    const data = await res.json();
                    renderResults(data);
                } catch (e) {
                    showError(e.message || 'Search failed');
                } finally {
                    hideLoading();
                }
            });

            // --- Edit & Run Custom ---
            editCustomButton.addEventListener('click', function () {
                if (!currentPreviewData) return;

                const allDorks = [];
                const dorksByEngine = currentPreviewData.dorks_by_engine || {};
                for (const [engine, dorks] of Object.entries(dorksByEngine)) {
                    dorks.forEach(d => allDorks.push(d));
                }
                customDorksTextarea.value = allDorks.join('\n');
                customEditorPanel.classList.remove('hidden');
            });

            cancelCustomButton.addEventListener('click', function () {
                customEditorPanel.classList.add('hidden');
            });

            runCustomSearchButton.addEventListener('click', async function () {
                const dorks = customDorksTextarea.value.split('\n').map(d => d.trim()).filter(d => d.length > 0);
                const engines = getSelectedEngines();
                if (dorks.length === 0) {
                    showError('Enter at least one dork query');
                    return;
                }
                if (engines.length === 0) {
                    showError('Select at least one search engine');
                    return;
                }

                previewPanel.classList.add('hidden');
                customEditorPanel.classList.add('hidden');
                statsContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';
                showLoading('Running custom dork search...');

                try {
                    const res = await fetch('/web/search/custom', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            dorks: dorks,
                            engines: engines,
                            max_results_per_dork: 10,
                            rate_limit_delay: 1.0
                        })
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail || 'Custom search request failed');
                    }

                    const data = await res.json();
                    renderResults(data);
                } catch (e) {
                    showError(e.message || 'Custom search failed');
                } finally {
                    hideLoading();
                }
            });

            // --- Render Results ---
            function renderResults(data) {
                const results = data.results || [];
                const enginesUsed = new Set();
                const dorksUsed = new Set();

                results.forEach(r => {
                    if (r.engine) enginesUsed.add(r.engine);
                    if (r.dork) dorksUsed.add(r.dork);
                });

                // Stats
                document.getElementById('statTotalResults').textContent = results.length;
                document.getElementById('statEnginesUsed').textContent = enginesUsed.size || data.engines_used || 0;
                document.getElementById('statDorksExecuted').textContent = dorksUsed.size || data.dorks_executed || 0;
                statsContainer.classList.remove('hidden');

                // Results
                resultsContainer.innerHTML = '';

                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-8 text-center">
                            <i data-lucide="search-x" class="w-10 h-10 text-gray-600 mx-auto mb-3"></i>
                            <p class="text-gray-400">No results found</p>
                            <p class="text-sm text-gray-500 mt-1">Try adjusting your query or using different dorks</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                results.forEach((result, index) => {
                    const url = result.link || result.url || '';
                    const domain = extractDomain(url);
                    const card = document.createElement('div');
                    card.className = 'bg-gray-900 border border-gray-700 rounded-lg p-5 hover:border-gray-600 transition-colors';
                    card.innerHTML = `
                        <div class="flex items-start justify-between gap-4 mb-2">
                            <div class="flex items-start gap-3 min-w-0">
                                ${domain ? `<img src="${faviconUrl(domain)}" alt="" width="16" height="16" class="mt-0.5 shrink-0 rounded-sm" onerror="this.style.display='none'">` : ''}
                                <a href="${escapeAttr(url || '#')}" target="_blank" rel="noopener noreferrer"
                                    class="text-white font-bold hover:text-gray-300 transition-colors text-sm leading-snug">
                                    ${escapeHtml(result.title || 'Untitled')}
                                </a>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                ${result.engine ? `<span class="text-xs px-2 py-0.5 rounded-full border border-gray-700 text-gray-400 uppercase tracking-wider">${escapeHtml(result.engine)}</span>` : ''}
                                <span class="text-xs text-gray-600">#${index + 1}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            ${domain ? `<span class="text-xs text-gray-400 font-bold">${escapeHtml(domain)}</span><span class="text-gray-700">|</span>` : ''}
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(url)}</p>
                        </div>
                        ${result.snippet ? `<p class="text-sm text-gray-400 leading-relaxed mb-3">${escapeHtml(result.snippet)}</p>` : ''}
                        ${result.dork ? `
                            <div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-800">
                                <i data-lucide="terminal" class="w-3 h-3 text-gray-600"></i>
                                <code class="text-xs text-gray-500 truncate">${escapeHtml(result.dork)}</code>
                            </div>
                        ` : ''}
                    `;
                    resultsContainer.appendChild(card);
                });

                lucide.createIcons();
            }

            // --- Utilities ---
            function escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }

            function escapeAttr(str) {
                if (!str) return '';
                return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }

            function extractDomain(url) {
                if (!url) return null;
                try {
                    const parsed = new URL(url);
                    return parsed.hostname;
                } catch (e) {
                    const match = url.match(/^(?:https?:\/\/)?([^\/\?#]+)/i);
                    return match ? match[1] : null;
                }
            }

            function faviconUrl(domain) {
                if (!domain) return '';
                return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=16`;
            }
        });
    </script>
    {% endblock %}
</body>

</html>
{% endblock %}
